<!DOCTYPE html>
<html>
<style type="text/css">
	body {
		font-family: monospace;
	}
</style>
<script src="draw.js"></script>
<script src="math2.js"></script>
<script src="Button.js"></script>
<head>
	<title>
		Balls!
	</title>
</head>
<body>
	<canvas style="border: 2px dashed green" id="main"></canvas>
	<script type="text/javascript">
		const MM = {
			c: document.getElementById('main')
		};
		const D = new Draw(MM.c);
		function init(){
			MM.c.width = window.innerWidth, MM.c.height = window.innerHeight;
			MM.ww = MM.c.width, MM.hh = MM.c.height;
			MM.mx = 0, MM.my = 0;
		}
		init();
	</script>
	<script src="Ball.js"></script>
	<script src="Me.js"></script>
	<script type="text/javascript">
		var size = 1e4;
		var startTime = Date.now();
		var dtime;
		var sc = 0;
		var bw = [];
		var controls1 = "mouse";
		var me = new Me();
		me.p = new Point2(MM.ww/2,MM.hh/2);
		var last = new Point2();
		function rm(event){
			var e = event || window.event;
			var mouseX = e.offsetX, mouseY = e.offsetY;
			for (var i = bw.length - 1; i >= 0; i--) {
				if(bw[i].in(mouseX,mouseY) && bw[i].f){
					bw[i].f();
				}
			}
			last.x = mouseX, last.y = mouseY;
		}
		MM.c.onmousedown = rm;
		function rm2(event){
			var e = event || window.event;
			var mouseX = e.offsetX, mouseY = e.offsetY;
			last.x = mouseX, last.y = mouseY;
		}
		MM.c.onmousemove = rm2;
		var keys = [];
		window.onkeydown = m1;
		window.onkeyup = m2;
		function m1(event){
			var e = event || window.event;
			var x = e.keyCode;
			keys[x] = true;
		}
		function m2(event){
			var e = event || window.event;
			var x = e.keyCode;
			keys[x] = false;
		}
		var maxSpeed = 4;
		var tDead = false, pDead = false;
		var maxHealth = 1000;
		var health = maxHealth;
		var healthColor;
		function healthBar(){
			var bit1 = decimalTo(Math.round((maxHealth-health)/1000*255/1.5),16);
			var bit2 = decimalTo(Math.round(health/1000*255),16);
			var bit3 = decimalTo(Math.round(health/1000*255/5),16);
			for(var i=0;i<2-bit1.length;i++){bit1 = "0"+bit1;}
			if(bit1.length<2){bit1 = "0"+bit1;}

			for(var i=0;i<2-bit2.length;i++){bit2 = "0"+bit2;}
			for(var i=0;i<2-bit3.length;i++){bit3 = "0"+bit3;}
			healthColor = "#"+bit1+bit2+bit3;

			D.fillRect(MM.ww/4, 10, MM.ww/2*health/maxHealth, 25, healthColor);

			var d = MM.c.getContext("2d");
			d.beginPath();
			d.lineWidth = 1;
			d.strokeStyle = "#000000";
			d.rect(MM.ww/4, 10, MM.ww/2, 25);
			d.stroke();

			D.fillText(health+"/"+maxHealth,MM.ww/2,25+25/4,"20px monospace", "#000000");
		}
		function grid(sp){
			var d = MM.c.getContext("2d");
			for(var xy=-size;xy<size;xy+=sp){
				if(xy+MM.mx<MM.ww && xy+MM.mx>0){
					d.beginPath();
					d.lineWidth = 1;
					d.strokeStyle = "#AAAAAA";
					d.moveTo(xy+MM.mx, -size+MM.my);
					d.lineTo(xy+MM.mx, size+MM.my);
					d.stroke();
				}
				if(xy+MM.my<MM.hh && xy+MM.my>0){
					d.beginPath();
					d.lineWidth = 1;
					d.strokeStyle = "#AAAAAA";
					d.moveTo(-size+MM.mx, xy+MM.my);
					d.lineTo(size+MM.mx, xy+MM.my);
					d.stroke();
				}
			}
		}
		var sc0Balls = [];
		var mainBalls = [];
		var playButt = new Button(MM.ww/2,MM.hh/4*3,MM.ww/3,MM.hh/5,"Play!",function(){
			sc = 1;
			this.f = null;
			sc0Balls = [];
			for(var i=0;i<1000;i++){
				var b = new Ball(random(-size,size),random(-size,size),random(50,120));
				b.v = new Point2(random(-1,1),random(-1,1));
				if(Point2.mag(Point2.sub(b.p,me.p))>500) mainBalls.push(b);
			}
		});
		for(var i=0;i<6;i++){
			var b = new Ball(random(0,MM.ww),random(0,MM.hh),random(10,40));
			b.v = new Point2(random(-1,1),random(-1,1));
			sc0Balls.push(b);
		}
		var d1 = 0, dt1 = 40;
		var ox = false, oy = false;
		function run(){
			if(Point2.mag(me.v)>maxSpeed){
				me.v = Point2.mult(Point2.normalize(me.v),maxSpeed);
			}
			dtime = startTime-Date.now();
			D.fillRect(0,0,MM.ww,MM.hh,"#FFFFFF");
			grid(84);
			if(sc == 0){
				playButt.run();
				D.strokeText("Balls!", MM.ww/2,MM.hh/4,Math.min(MM.ww,MM.hh)/4+"px monospace","#0000FF");
				for (var i = sc0Balls.length - 1; i >= 0; i--) {
					sc0Balls[i].edge();
					sc0Balls[i].update();
				}
				for (var i = sc0Balls.length - 1; i >= 0; i--) {
					sc0Balls[i].draw();
				}
				Balls.solve(sc0Balls);
				if(d1 == 0 && sc0Balls.length<50){
					var b = new Ball(50,50,random(15,36));
					b.v = new Point2(random(1,2),random(1,2));
					sc0Balls.push(b);
				}
				d1 = (d1+1)%dt1;
			}else if(sc == 1){
				me.a+=0.04;
				me.update();
				me.draw();
				me.v.mult(0.982);
				Balls.solve(mainBalls);
				for (var i = mainBalls.length - 1; i >= 0; i--) {
					mainBalls[i].edge2();
					mainBalls[i].update();
				}
				for (var i = mainBalls.length - 1; i >= 0; i--) {
					mainBalls[i].draw();
				}
				healthBar();
				var sp = 1/3;
				if(controls1 == "keys"){
					if(keys[37]){
						me.v.x-=sp;
					}
					if(keys[38]){
						me.v.y-=sp;
					}
					if(keys[39]){
						me.v.x+=sp;
					}
					if(keys[40]){
						me.v.y+=sp;
					}

					if(keys[65]){
						me.v.x-=sp;
					}
					if(keys[87]){
						me.v.y-=sp;
					}
					if(keys[68]){
						me.v.x+=sp;
					}
					if(keys[83]){
						me.v.y+=sp;
					}
				}else if(controls1 == "mouse"){
					var n = Point2.normalize(Point2.sub(last,new Point2(me.p.x+MM.mx,me.p.y+MM.my)));
					me.v.add(Point2.mult(n,sp));
				}

				var l1 = 6, l2 = 10;
				var d = Point2.sub(new Point2(MM.ww/2,MM.hh/2),new Point2(me.p.x+MM.mx,me.p.y+MM.my));
				var m = Point2.mag(d);
				if(ox && me.p.x+MM.mx<MM.ww/2 && last.x>me.p.x+MM.mx){
					ox = false;
				}
				if(ox && me.p.x+MM.mx>MM.ww/2 && last.x<me.p.x+MM.mx){
					ox = false;
				}

				if(oy && me.p.y+MM.my<MM.hh/2 && last.y>me.p.y+MM.my){
					oy = false;
				}
				if(oy && me.p.y+MM.my>MM.hh/2 && last.y<me.p.y+MM.my){
					oy = false;
				}
				if(ox){
					var t = map(Math.abs(me.p.x+MM.mx-MM.ww/2),MM.ww/l2,MM.ww/l1,0,1);
					MM.mx-=me.v.x*t;
				}
				if(oy){
					var t = map(Math.abs(me.p.y+MM.my-MM.hh/2),MM.hh/l2,MM.hh/l1,0,1);
					MM.my-=me.v.y*t;
				}
				if(Math.abs(me.p.x+MM.mx-MM.ww/2)>MM.ww/l2){
					ox = true;
				}
				if(Math.abs(me.p.y+MM.my-MM.hh/2)>MM.hh/l2){
					oy = true;
				}
				me.p.x = constrain(me.p.x,-size,size);
				me.p.y = constrain(me.p.y,-size,size);
			}
			setTimeout(run, 10);
		}
		run();
	</script>
</body>
</html>